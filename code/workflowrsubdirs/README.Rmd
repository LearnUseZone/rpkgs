---
title:  "[workflowrsubdirs](https://github.com/LearnUseZone/workflowrSubfolders)"
author: LearnUseZone
date:   "`r paste('Last update:', format(lubridate::with_tz(as.POSIXct(Sys.time()) + 7200, tzone = 'GMT'), '%Y-%m-%d %H:%M GMT+2'))`"
output:
  github_document:
    toc: true
    toc_depth: 1
    html_preview: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  # comment = "#>",
  eval = FALSE
)
```



## Purpose
This package is used (only) to build HTML files
from their associated R Markdown files saved in a new directory and its subdirectories
of a [workflowr](https://github.com/jdblischak/workflowr) project. \

- [Package workflowr offers](https://github.com/jdblischak/workflowr/blob/master/README.md) many
useful features but doesn\'t offer this feature of `workflowrsubdirs` package.



## General rules
### Directory structure
- Because this package is a kind of an (optional) extension for package `workflowr`,
  it's necessary to adhere the structure of the main
  [workflowr project\'s working directory](https://jdblischak.github.io/workflowr/articles/wflow-01-getting-started.html)
  (hereinafter `main workflowr dir`). The most important directories to follow this rule are:
  - `analysis`
  - `code`
  - `docs` (for GitHub) or `public` (for GitLab)


### Subdirectories for R Markdown files
- 1stly, `workflowr` project needs to be prepared.
    - Relevant steps (together with more information) can be found
      [here](https://jdblischak.github.io/workflowr/articles/wflow-01-getting-started.html).
      Read e.g. about directories:
      - `code` that can contain also subdirectories.
      - `docs` that contain all HTML files for your website. These HTML files are built
        from R Markdown files in directories `analysis` and `code-rmd subdirs`.
- 2ndly, ensure that `docs/index.html` is created, e.g by running `workflowr::wflow_build()`.
    - Ideal is to also properly prepare files `_site.yml` and `index.Rmd` in directory `analysis`
      and also directories with HTML files included in `_site.yml` (e.g. `footer.html`).
- For the purpose of saving R Markdown files in subdirectories, it's necessary
  to create a new directory directly in `main workflowr dir`.
    - Don't create subdirectories (for this purpose) in directory `analysis`.
    - Required name of this new directory is `code-rmd`
      - R Markdown files saved in it will be usually associated to solutions in directory `code`.
- R Markdown files can be saved
    - directly in this new directory or in any of its subdirectories (hereinafter `code-rmd subdirs`).
- Following 2 approaches can be used to show results of solutions from directory `code`
  and keep them organized:
    1. Create associated R Markdown files to directory `analysis` and
       build their HTML files using package `workflowr`.
       - this approach cannot have the same structure as subdirectories in directory `code`.
    2. Create associated R Markdown files to `code-rmd subdirs` and build
       their HTML files using package `workflowrsubdirs`.
       - This approach can have the same structure as directory \"code\".


### Open `workflowr` project before using `workflowrsubdirs`
- If other than `workflowr` project is originally opened (using its .Rproj file)
  then function `workflowrsubdirs::build_htmls()` fails because
  `base::setwd(here::here())` in this function sets a working directory to
  an original .Rproj working directory regardless a (later changed) current working directory.


### Only files with extension .rmd or .Rmd are allowed
It\'s required that original (source) R Markdown files have an extension .rmd or .Rmd. \
This behavior is in accordance with package `workflowr` where if the file extension is
not .rmd or .Rmd then rendering will fail with error \"Error: Invalid input for argument files\".



## Package functions
### build_htmls()
This is currently the only one function accessible by users. \

Main steps:

  1. Evaluate if rendering of R Markdown to HTML files is possible. If some check doesn\'t pass,
     write a reason and stop processing.
     - Used package function: initial_checks()
  2. Create paths to original R Markdown files. Non-existent R Markdown files are ignored.
     An R Markdown file referred by more than 1 regular expression is processed only once.
     - Used package function: create_rmd_paths()
  3. Create a temporary copy of original R Markdown files to directory "code-rmd"
     (it's needed to be able to use figures generated by functions like e.g. graphics::hist()).
     Generate temporary (helping) R Markdown files from associated
     temporary code-rmd R Markdown files and save them to directory `analysis`.
     - Used package function: render_to_htmls()
  4. If input parameter `commit == TRUE`, create a commit of these
     temporary analysis R Markdown files with text
     \"feat: separate commit of temporary analysis .(r|R)md files\".
     - Used function: workflowr::wflow_git_commit()
     - If these temporary analysis R Markdown files are not committed before
       workflowr::wflow_build(), the following error message is written after
       opening any of prepared HTML files and
       left-clicking on `workflowr` button under tab \"Checks\":
       \"R Markdown file: uncommitted changes\"
         - This is also inline with `workflowr` package.
  5. Render temporary (helping) R Markdown files in directory `analysis` to HTML files.
     - Used function: workflowr::wflow_build()
     - Final HTML files are prepared (also package `workflowr` is set in this way)
       in directory `docs` (for GitHub) or directory `public` (for GitLab).
       Each such file name contains `\-\-` which are delimiters
       for paths to original R Markdown file paths.
  6. Delete temporary R Markdown files in directories `code-rmd` and `analysis`.



## How to easily avoid potential problems
### YAML headers
- It's necessary to use correct quotation marks if inline R code is used in YAML header.
  otherwise there is an error with rendering R Markdown to HTML file. \

- Example of using quotation marks (in this case: `"`) incorrectly:
  ```{r}
  date:    "`r paste("Last update:", format(lubridate::with_tz(as.POSIXct(Sys.time()) + 7200,
           tzone = "GMT"), "%Y-%m-%d %H:%M GMT+2"))`"
  ```

- Single quotation marks (\') have to be used in inline R codes in YAML header
  in R Markdown files saved in directory \"analysis\", for example: \
  ```{r}
  date:    "`r paste('Last update:', format(lubridate::with_tz(as.POSIXct(Sys.time()) + 7200,
           tzone = 'GMT'), '%Y-%m-%d %H:%M GMT+2'))`"
  ```

- Escaped double quotation marks (\\\") have to be used in inline R codes in YAML header
  in R Markdown files saved in \"code-rmd subdirs\", for example: \
  ```{r}
  date:    "`r paste(\"Last update:\", format(lubridate::with_tz(as.POSIXct(Sys.time()) + 7200,
           tzone = \"GMT\"), \"%Y-%m-%d %H:%M GMT+2\"))`"
  ```

- Examples of errors if incorrect quotation marks are used:
  - `workflowr::wflow_build("analysis/testfile.Rmd")`
    - `'`   -  working
    - `\'`  -  Scanner error: while parsing a quoted scalar at line 3, column 10 found unknown
               escape character at line 3, column 20
    - `"`   -  Parser error: while parsing a block mapping at line 1, column 1 did not find expected key at line 3, column 21
    - `\"`  -  Error: callr subprocess failed: \<text\>:1:7: unexpected input
    - `''`  -  Error: callr subprocess failed: \<text\>:1:9: unexpected symbol \
\
  - `workflowrsubdirs::build_htmls("code-rmd/subdir", F, "testfile.Rmd")`
    - `'`   -  Error: callr subprocess failed: \<text\>:1:9: unexpected symbol (\'\' is created)
    - `\'`  -  Scanner error: while parsing a quoted scalar at line 3, column 10 found unknown
               escape character at line 3, column 20
    - `"`   -  Parser error: while parsing a block mapping at line 1, column 1 did not find expected key at line 3, column 21
    - `\"`  -  working
    - `''`  -  Error: callr subprocess failed: \<text\>:1:9: unexpected string constant


### Problems when R Markdown file contains space in its name
- It's necessary to not use spaces in R Markdown file names otherwise following errors occur.
    - It's unusual to have file names, that will be used for web addresses, containing spaces
      so the easiest way how to avoid following errors is simply to not use spaces
      in R Markdown file names.
- Error when R Markdown file saved in `code-rmd subdirs` contain a space in its name after running
  e.g. following code is: Error: callr subprocess failed: cannot open the connection
    ```{r}
    workflowrsubdirs::build_htmls("code-rmd/subdir", F, "file.Rmd")
    ```
- Error when R Markdown file saved in directory `analysis` contain a space
  in its name after running e.g. following code is:
  Error: callr subprocess failed: The specified directory \'D:/Projects/GitLab/portfolios/test file.Rmd\' does not exist.
  (This error message is strange because directory \"analysis\" isn\'t written there.)
    ```{r}
    workflowr::wflow_build("analysis/file.Rmd")
    ```
- It seems that both of these errors are caused directly by package `workflowr`.
  J. Blischak (creator of package `workflowr`) will add a better error message
  (or maybe another suitable solution) as we discuss [here](https://github.com/jdblischak/workflowr/issues/226).



## Installation steps (for Windows)
1. Clone this Git [rpkgs repository](https://github.com/LearnUseZone/rpkgs).
2. Open `rpkgs/code/workflowrsubdirs/workflowrsubdirs/workflowrsubdirs.Rproj` in RStudio.
3. Build (from RStudio top menu) -> Build Source Package -> wait until .tar.gz file is created.
4. Unload package `workflowrsubdirs` (if it's loaded within tab \"Packages\") to avoid
   the following warning: \
      Warning in install.packages : \
      \ \ package ‘workflowrsubdirs’ is in use and will not be installed
   - Examples: \
     4a) Session (from RStudio top menu) -> Restart R (Ctrl+Shift+F10) \
     4b) Open tab \"Packages\" -> find package `workflowrsubdirs` -> uncheck a relevant check box \
     4c) `detach("package:workflowrsubdirs", unload = TRUE)`
5. Install the package using R code:
   `install.packages(<path_to_tar.gz_file>, repos = NULL, type = "source")`
6. Notes
    - Don\'t use Build (from top menu of RStudio) -> Install and Restart (Ctrl+Shift+B) because of
    problems explained [here](https://stackoverflow.com/questions/65004638/stop-in-package-function-doesnt-end-debug-mode).
        - [Here](https://stackoverflow.com/questions/1474081/how-do-i-install-an-r-package-from-source/1474125#1474125)
          can be found additional information e.g. regarding UNIX.
    - This package still doesn\'t have any stable version therefore previous installation steps
      are suggested.


### Try following steps if it seems that the package wasn\'t installed properly
1. Restart R session for each opened RStudio session
   - Continue with following steps if this doesn\'t help.
2. Uninstall this package from RStudio \"Packages\" tab if it exists there.
3. Delete directory `workflowrsubdirs` from directory `library`
   (directory with installed R packages) if it exists there.
4. Restart R session
   - for example using RStudio -> Session -> Restart R.
5. Install the package again using R code:
   install.packages(<path_to_tar.gz_file>, repos = NULL, type = \"source\").



## Necessary packages
It's necessary to install following packages for a proper usage
of this package (loading them isn't necessary):

- `base`
- `here`
- `rmarkdown`
- `stringr`
- `workflowr`
- `yaml`



## Example of using package workflowrsubdirs
Simple examples of iris dataset analyses are saved
[here](https://github.com/LearnUseZone/rpkgs/tree/master/code/examples/iris). \
Their associated R Markdown files are saved
[here](https://github.com/LearnUseZone/rpkgs/tree/master/code-rmd/examples/iris). \

These prepared HTML examples demonstrate (for example):

- an example of possible directories structure
- correct functionality of `workflowrsubdirs::build_htmls()`
    - differences between `workflowrsubdirs::build_htmls()` and
      standard knitting (Knit button, `knitr::knit()`) are only:
        - `workflowrsubdirs::build_htmls()` is of course called instead of `knitr::knit()`
        - figures (e.g. when running graphics::hist()) are saved to directory `rpkgs/docs/figure`
        - directory structure of packages `workflowr` and `workflowrsubdirs` are used
          to keep data files organized
        - rules for using of package `workflowr` have to be met
- usage of \"footer\"
    - File `footer.html` is saved in `rpkgs/analysis/include` which is
      in line with package `workflowr` (see e.g. [here](https://zenodo.org/record/3706876#.X9CkkLMo_cs)).
    - It's working in combination with definition of \"output\"
      in file `rpkgs/analysis/_site.yml` (commit 96087f9).
- usage of \"picture\"
    - A picture `3-species-of-iris.png` saved
      in directory `rpkgs/docs/assets/examples/iris/static-visuals/histograms.Rmd`
      is used in `rpkgs/code-rmd/examples/iris/static-visuals/histograms.Rmd`.
    - A picture could be saved also in other part of `rpkgs/docs/assets` which is
      in line with package `workflowr` (read more
      [here](https://jdblischak.github.io/workflowr/articles/wflow-05-faq.html)).
- static visualizations with figures
    - File `rpkgs/code-rmd/examples/iris/static-visuals/histograms.Rmd` uses one .R file.
    - File `rpkgs/code-rmd/examples/iris/static-visuals/plots.Rmd` uses two .R files.
    - Both R Markdown files generate figures that are
      automatically (functionality of package `workflowr`) saved in directories
      `rpkgs/docs/figure/examples--iris--static-visuals--histograms.Rmd` and
      `rpkgs/docs/figure/examples--iris--static-visuals--plots.Rmd`.
    - Based on functionality of package `workflowr` if a .png file already exist,
      it's overwritten with a new file but remains saved even if it's deleted
      from the source R Markdown or .R file.
    - More information is
      [here](https://jdblischak.github.io/workflowr/articles/wflow-04-how-it-works.html#where-are-the-figures)
    - Also for example package ggplot2 is used (in \"boxplots.R\").
- interactive visualization
    - It's used in `rpkgs/code-rmd/examples/iris/interactive-visuals/plotly.Rmd`.
    - It's also used:
      - [code externalization](https://bookdown.org/yihui/rmarkdown-cookbook/read-chunk.html)
      - packages: plotly and crosstalk
- usage of `knitr::opts_chunk$set()`
    - It's used in all R Markdown files.


There are several options to render all of these R Markdown files
to HTML files. Some examples follow.

- If you want to try following options by yourself, remember to 1stly run file `rpkgs/rpkgs.Rproj`
  which also set the correct working directory
  (read more in subtitle \"Open `workflowr` project before using `workflowrsubdirs`\").

```{r}
# render all .rmd and .Rmd files in directory "code-rmd" and its subdirectories to .html files
#   note: all .rmd and Rmd files anywhere under "code-rmd" will be processed
workflowrsubdirs::build_htmls()

# render all .rmd and .Rmd files in directory "code-rmd/examples" and its subdirectories to .html files
#   note: all .rmd and .Rmd files anywhere under "code-rmd/examples" will be processed
#         all 3 following codes are equivalent
workflowrsubdirs::build_htmls(dir_path = "code-rmd/examples")
workflowrsubdirs::build_htmls(dir_path = "code-rmd\\examples")
workflowrsubdirs::build_htmls(dir_path = "code-rmd/examples", patterns = ".*.(r|R)md$")

# render .rmd and .Rmd files based on different regular expressions in parameter "patterns"
workflowrsubdirs::build_htmls(dir_path = "code-rmd/examples/iris",
                              subdirs = T,
                              patterns = c(
                                "-.*.[r,R]md",
                                "hist.*.Rmd$",
                                "plot.{1,2}\\.(?i)rmd",
                                "plotly.Rmd")
                              )
# the code I've actually used to generate all .html files follows
#   note: previous examples generated HTML files but didn't create
#         separate commit of temporary analysis R Markdown files
#         (see input parameter commit) which means that after
#         a created HTML file is opened, workflowr button will show in "Checks" tab error:
#         R Markdown file: uncommitted changes
workflowrsubdirs::build_htmls("code-rmd/examples/iris", T, NULL, T)
```

- Notes
    - If also files in directory `analysis` need to be updated using package `workflowr`,
      a code like the following one (which I've actually used) can be used:
    
    ```{r}
    workflowr::wflow_publish(
        files = c("analysis/_site.yml", "analysis/about.Rmd",
                  "analysis/index.Rmd", "analysis/license.Rmd"),
        message = "feat(workflowrsubdirs): Update .html examples using workflowr")
    ```


### Usage of workflowrsubdirs after it\'s installed
1. After `workflowrsubdirs` is installed, open your `workflowr` project (run .Rproj file).
2. Use: `workflowrsubdirs::build_htmls()`
3. Remember that although temporary R Markdown files are committed separately within function
   `workflowrsubdirs::build_htmls()`, it's still necessary to commit all files
   after HTML files are prepared (commit of all removed temporary R Markdown files and
   new HTML files). \ \
   There are more approaches for this purpose e.g.:
    - 3a) GitHub Desktop, Sourcetree or other Git desktop client.
    - 3b) Git Bash (also set as Terminal in RStudio) with git commands like:
    ```{r git_commands, engine = 'bash'}
    git branch -a       # I prefer to check which branch is checked out
    git add "."
    git commit -m "feat: Add new HTML files"
    ```
    - 3c) Functions of package `workflowr` like:
    `workflowr::wflow_git_commit()` and `workflowr::wflow_publish()`.



## Additional notes
- I'm still working on improvements (I don't have a stable version), some of them follow:
  - replace some placeholders like `tests\testthat\test-build_htmls.R` with a solution,
  - replace comments for future improvements with relevant improvements,
  - check and update comments and roxygen2 descriptions,
  - check and update some parts of R codes.
- This package `workflowrsubdirs` is available under the
  [MIT license](https://opensource.org/licenses/mit-license.php).
- Initial inspiration for this package is from
  [this discussion](https://github.com/jdblischak/workflowr/issues/95). \
- A related discussion with John Blischak (a creator of package `workflowr`) about some of
  used concepts is [here](https://github.com/jdblischak/workflowr/issues/220).
